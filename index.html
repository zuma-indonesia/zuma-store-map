<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuma Indonesia - Store Mapping & Visit Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary: #1a1a2e; --secondary: #16213e; --accent: #e94560; --gold: #f4a261;
            --teal: #2a9d8f; --green: #06d6a0; --blue: #1565c0; --purple: #7b1fa2; --orange: #ef6c00;
            --white: #fefefe; --gray-100: #f8f9fa; --gray-200: #e9ecef; --gray-300: #dee2e6; --gray-600: #6c757d;
            --shadow: 0 10px 40px rgba(26,26,46,0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f5f7fa; min-height: 100vh; color: var(--primary); }
        .app { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }

        /* Sidebar */
        .sidebar { background: var(--white); box-shadow: var(--shadow); display: flex; flex-direction: column; z-index: 1000; overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 16px; color: white; }
        .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .logo-icon { width: 40px; height: 40px; border-radius: 8px; overflow: hidden; }
        .logo-icon img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0) invert(1); }
        .logo h1 { font-size: 18px; font-weight: 800; }
        .logo span { font-size: 10px; opacity: 0.8; display: block; }

        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .stat { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; text-align: center; }
        .stat .num { font-family: 'Space Mono', monospace; font-size: 22px; font-weight: 700; color: var(--gold); }
        .stat .lbl { font-size: 9px; text-transform: uppercase; opacity: 0.8; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--gray-200); background: var(--gray-100); }
        .tab { flex: 1; padding: 14px; border: none; background: none; font-family: inherit; font-size: 12px; font-weight: 600; color: var(--gray-600); cursor: pointer; position: relative; transition: all 0.2s; }
        .tab:hover { color: var(--primary); }
        .tab.active { color: var(--accent); background: var(--white); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--accent); }
        .tab .badge { background: var(--accent); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 6px; }

        .tab-content { display: none; flex: 1; overflow: hidden; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* Search */
        .search { padding: 12px; border-bottom: 1px solid var(--gray-200); }
        .search input { width: 100%; padding: 10px 14px 10px 38px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 12px; font-family: inherit; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236c757d' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 10px center/18px; transition: all 0.2s; }
        .search input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(233,69,96,0.1); }

        .filters { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
        .filter { padding: 6px 12px; border: 2px solid var(--gray-200); background: white; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .filter:hover { border-color: var(--gray-300); }
        .filter.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Store List */
        .list { flex: 1; overflow-y: auto; padding: 8px; }
        .list::-webkit-scrollbar { width: 6px; }
        .list::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 3px; }

        .card { background: var(--white); border: 2px solid var(--gray-200); border-radius: 12px; padding: 14px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .card:hover { border-color: var(--accent); box-shadow: 0 4px 20px rgba(233,69,96,0.15); transform: translateY(-1px); }
        .card.in-route { border-color: var(--gold); background: linear-gradient(135deg, rgba(244,162,97,0.05), white); }

        .card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .card-name { font-weight: 700; font-size: 14px; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .badge.bali { background: #e0f2f1; color: #00695c; }
        .badge.jawa-timur { background: #e3f2fd; color: #1565c0; }
        .badge.jakarta { background: #f3e5f5; color: #7b1fa2; }
        .badge.lombok-nusra { background: #fff3e0; color: #ef6c00; }
        .badge.pekanbaru { background: #fff8e1; color: #f57f17; }
        .badge.batam-kepri { background: #e8f5e9; color: #2e7d32; }
        .badge.sulawesi { background: #fce4ec; color: #c2185b; }

        .card-loc { font-size: 11px; color: var(--accent); font-weight: 600; margin-bottom: 4px; }
        .card-addr { font-size: 11px; color: var(--gray-600); line-height: 1.4; margin-bottom: 8px; }
        .card-meta { display: flex; gap: 12px; font-size: 11px; color: var(--gray-600); margin-bottom: 10px; }
        .card-actions { display: flex; gap: 6px; }

        .btn { padding: 8px 14px; border: none; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #d63850; transform: translateY(-1px); }
        .btn-gold { background: var(--gold); color: white; }
        .btn-gold:hover { background: #e8944f; }
        .btn-gray { background: var(--gray-100); color: var(--primary); }
        .btn-gray:hover { background: var(--gray-200); }

        /* Route Section */
        .route-section { border-top: 1px solid var(--gray-200); background: var(--gray-100); }
        .route-header { padding: 14px; background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; }
        .route-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .route-title h3 { font-size: 14px; }
        .route-btns { display: flex; gap: 6px; }
        .route-btns button { padding: 6px 10px; border: none; background: rgba(255,255,255,0.15); border-radius: 6px; color: white; cursor: pointer; font-size: 11px; font-family: inherit; transition: all 0.2s; }
        .route-btns button:hover { background: rgba(255,255,255,0.25); }

        .route-stats { display: flex; gap: 20px; }
        .route-stat { display: flex; align-items: center; gap: 8px; }
        .route-stat .icon { font-size: 16px; }
        .route-stat .val { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; color: var(--gold); }
        .route-stat .lbl { font-size: 10px; opacity: 0.8; }

        /* Start Point Selector */
        .start-section { padding: 12px; background: var(--gray-100); border-bottom: 1px solid var(--gray-200); }
        .start-label { font-size: 11px; font-weight: 700; color: var(--gray-600); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .start-options { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
        .start-opt { padding: 6px 10px; border: 2px solid var(--gray-200); background: white; border-radius: 8px; font-size: 10px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        .start-opt:hover { border-color: var(--accent); }
        .start-opt.active { background: var(--accent); color: white; border-color: var(--accent); }
        .start-input-wrap { display: flex; gap: 6px; }
        .start-input { flex: 1; padding: 8px 12px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 11px; font-family: inherit; }
        .start-input:focus { outline: none; border-color: var(--accent); }
        .start-input::placeholder { color: var(--gray-600); }
        .start-current { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: linear-gradient(135deg, var(--green), #05c491); color: white; border-radius: 8px; font-size: 11px; font-weight: 600; margin-top: 8px; }
        .start-current .coords { font-family: 'Space Mono', monospace; font-size: 10px; opacity: 0.9; }
        .start-current .clear-btn { margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 10px; }
        .start-current .clear-btn:hover { background: rgba(255,255,255,0.3); }

        /* Search Results */
        #searchResults { max-height: 200px; overflow-y: auto; margin-top: 8px; }
        .search-result-item { padding: 10px 12px; background: white; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
        .search-result-item:hover, .search-result-item:active { background: var(--gray-100); border-color: var(--accent); }
        .search-result-name { font-weight: 600; font-size: 12px; margin-bottom: 2px; }
        .search-result-addr { font-size: 10px; color: var(--gray-600); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-loading, .search-no-result { padding: 12px; text-align: center; color: var(--gray-600); font-size: 12px; }
        .search-loading { color: var(--accent); }

        .route-chips { display: flex; flex-direction: column; gap: 8px; }
        .chip { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--gray-100); border-radius: 10px; font-size: 13px; font-weight: 600; cursor: grab; transition: all 0.2s; }
        .chip:hover { background: var(--gray-200); }
        .chip.start { background: linear-gradient(135deg, var(--accent), #d63850); color: white; cursor: pointer; }
        .chip.start.custom { background: linear-gradient(135deg, var(--green), #05c491); }
        .chip .num { width: 28px; height: 28px; background: var(--gold); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; }
        .chip .info { flex: 1; }
        .chip .name { font-weight: 700; }
        .chip .dist { font-size: 11px; color: var(--gray-600); font-weight: 500; }
        .chip.start .dist { color: rgba(255,255,255,0.8); }
        .chip .remove { width: 24px; height: 24px; background: rgba(0,0,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; flex-shrink: 0; transition: all 0.2s; }
        .chip .remove:hover { background: var(--accent); color: white; }

        .route-list-container { flex: 1; overflow-y: auto; padding: 12px; background: white; }
        .route-action { padding: 12px; border-top: 1px solid var(--gray-200); }
        .btn-full { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; margin-bottom: 8px; }
        .btn-full:last-child { margin-bottom: 0; }
        .btn-full.primary { background: var(--gold); color: var(--primary); }
        .btn-full.primary:hover { background: #e8944f; transform: translateY(-1px); }
        .btn-full.secondary { background: var(--gray-100); color: var(--primary); }
        .btn-full.secondary:hover { background: var(--gray-200); }

        /* Map */
        .map-wrap { position: relative; }
        #map { width: 100%; height: 100%; }

        /* Detail Panel */
        .detail-panel { position: absolute; top: 14px; left: 14px; z-index: 1000; background: white; border-radius: 12px; box-shadow: var(--shadow); width: 300px; max-height: 70vh; overflow: hidden; display: none; }
        .detail-panel.visible { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

        .detail-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--gray-200); }
        .detail-header h4 { font-size: 14px; font-weight: 700; }
        .detail-close { width: 28px; height: 28px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .detail-close:hover { background: var(--accent); color: white; }

        .detail-list { padding: 8px; max-height: calc(70vh - 60px); overflow-y: auto; }
        .detail-item { display: flex; gap: 12px; padding: 12px; border-radius: 10px; margin-bottom: 6px; background: var(--gray-100); transition: all 0.2s; cursor: pointer; }
        .detail-item:hover { background: var(--gray-200); }
        .detail-item.start { background: linear-gradient(135deg, rgba(233,69,96,0.1), rgba(233,69,96,0.05)); }
        .detail-item.start.custom { background: linear-gradient(135deg, rgba(6,214,160,0.1), rgba(6,214,160,0.05)); }

        .detail-num { width: 32px; height: 32px; background: var(--gold); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; flex-shrink: 0; }
        .detail-num.start { background: var(--accent); color: white; }
        .detail-num.start.custom { background: var(--green); }

        .detail-info { flex: 1; min-width: 0; }
        .detail-name { font-weight: 700; font-size: 13px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .detail-sub { font-size: 10px; color: var(--gray-600); }
        .detail-from { font-size: 10px; color: var(--accent); font-weight: 600; margin-top: 4px; }

        .detail-dist { text-align: right; flex-shrink: 0; }
        .detail-dist .km { font-family: 'Space Mono', monospace; font-size: 15px; font-weight: 700; color: var(--accent); }
        .detail-dist .time { font-size: 10px; color: var(--gray-600); }

        /* Map Controls */
        .map-ctrls { position: absolute; top: 14px; right: 14px; z-index: 1000; display: flex; flex-direction: column; gap: 6px; }
        .map-btn { width: 40px; height: 40px; background: white; border: none; border-radius: 10px; box-shadow: var(--shadow); cursor: pointer; font-size: 18px; transition: all 0.2s; }
        .map-btn:hover { transform: scale(1.1); }
        .map-btn.active { background: var(--accent); }

        /* Legend */
        .legend { position: absolute; bottom: 20px; right: 14px; z-index: 1000; background: white; padding: 14px; border-radius: 12px; box-shadow: var(--shadow); }
        .legend-title { font-size: 11px; font-weight: 700; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 10px; margin-bottom: 5px; }
        .legend-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .legend-dot.bali { background: var(--teal); }
        .legend-dot.jatim { background: var(--blue); }
        .legend-dot.jakarta { background: var(--purple); }
        .legend-dot.lombok { background: var(--orange); }
        .legend-dot.pekanbaru { background: var(--gold); }
        .legend-dot.batam { background: var(--green); }
        .legend-dot.sulawesi { background: var(--accent); }

        /* Popup */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0; min-width: 250px; }
        .popup-head { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 12px 14px; color: white; }
        .popup-head h4 { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
        .popup-head span { font-size: 10px; opacity: 0.9; }
        .popup-body { padding: 14px; }
        .popup-addr { font-size: 11px; color: var(--gray-600); margin-bottom: 10px; line-height: 1.5; }
        .popup-dist { display: flex; align-items: center; gap: 6px; font-size: 12px; margin-bottom: 12px; padding: 8px 12px; background: var(--gray-100); border-radius: 8px; }
        .popup-dist .icon { color: var(--accent); }
        .popup-dist .value { font-family: 'Space Mono', monospace; font-weight: 700; color: var(--accent); }
        .popup-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer; font-family: inherit; background: var(--gold); color: var(--primary); transition: all 0.2s; }
        .popup-btn:hover { background: #e8944f; }

        /* Toast */
        .toast-wrap { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
        .toast { background: var(--primary); color: white; padding: 12px 20px; border-radius: 10px; font-size: 13px; margin-bottom: 8px; animation: toastIn 0.3s; box-shadow: var(--shadow); }
        .toast.success { background: var(--green); }
        .toast.error { background: var(--accent); }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading */
        .loading { position: fixed; inset: 0; background: rgba(26,26,46,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s; }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { color: white; margin-top: 16px; font-size: 14px; }

        .leaflet-routing-container { display: none !important; }

        /* Click mode indicator */
        .click-mode-active #map { cursor: crosshair !important; }
        .click-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--accent); color: white; padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; z-index: 2000; animation: pulse 1.5s infinite; display: none; }
        .click-mode-active .click-indicator { display: block; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Mobile Bottom Nav */
        .mobile-nav { display: none; }

        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 768px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
                height: 100vh;
                height: 100dvh;
            }

            /* Sidebar as overlay */
            .sidebar {
                position: fixed;
                bottom: 60px;
                left: 0;
                right: 0;
                top: 0;
                z-index: 2000;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            }
            .sidebar.open { transform: translateY(0); }

            /* Compact header for mobile */
            .header { padding: 12px; }
            .logo { margin-bottom: 8px; }
            .logo-icon { width: 32px; height: 32px; font-size: 14px; }
            .logo h1 { font-size: 16px; }
            .stats { gap: 6px; }
            .stat { padding: 8px 6px; }
            .stat .num { font-size: 18px; }
            .stat .lbl { font-size: 8px; }

            /* Tabs */
            .tabs { position: sticky; top: 0; z-index: 10; }
            .tab { padding: 12px 8px; font-size: 11px; }

            /* Search & Filters */
            .search { padding: 10px; }
            .search input { padding: 12px 14px 12px 38px; font-size: 14px; }
            .filters { gap: 4px; }
            .filter { padding: 6px 10px; font-size: 10px; }

            /* Cards - compact seperti tabel */
            .card {
                padding: 8px 10px;
                margin-bottom: 0;
                border-radius: 0;
                border: none;
                border-bottom: 1px solid var(--gray-200);
            }
            .card:active { background: var(--gray-100); }
            .card-head { margin-bottom: 2px; }
            .card-name { font-size: 12px; }
            .card-loc { display: none; }
            .card-addr { display: none; }
            .card-meta { margin-bottom: 4px; font-size: 10px; }
            .card-actions { display: none; }
            .badge { padding: 2px 6px; font-size: 8px; }

            /* Route Section */
            .route-header { padding: 12px; }
            .route-title { flex-direction: column; align-items: flex-start; gap: 8px; }
            .route-title h3 { font-size: 13px; }
            .route-btns { width: 100%; }
            .route-btns button { flex: 1; padding: 8px 6px; font-size: 10px; }
            .route-stats { gap: 12px; justify-content: space-between; width: 100%; }
            .route-stat .val { font-size: 16px; }
            .route-stat .lbl { font-size: 9px; }

            /* Start Section */
            .start-section { padding: 10px; }
            .start-label { font-size: 10px; margin-bottom: 6px; }
            .start-options { gap: 4px; }
            .start-opt { padding: 8px 8px; font-size: 9px; flex: 1; justify-content: center; min-width: 70px; }
            .start-input { padding: 10px; font-size: 12px; }
            .start-current { padding: 10px; font-size: 10px; }

            /* Chips - sama persis dengan card toko */
            .route-chips {
                display: block;
                padding-bottom: 120px;
            }
            .chip {
                display: flex;
                padding: 8px 10px;
                font-size: 12px;
                border-radius: 0;
                background: white;
                border-bottom: 1px solid var(--gray-200);
                margin-bottom: 0;
                cursor: default !important;
                touch-action: pan-y !important;
                user-select: none;
            }
            .chip:active { background: var(--gray-100); }
            .chip .num { width: 24px; height: 24px; font-size: 11px; }
            .chip .dist { font-size: 10px; }
            .chip .remove { width: 26px; height: 26px; font-size: 14px; }

            /* Force scroll pada container */
            .route-list-container {
                overflow-y: scroll !important;
                -webkit-overflow-scrolling: touch !important;
                overscroll-behavior: contain;
            }

            /* Scroll sama persis dengan toko */
            .list, .route-list-container {
                flex: 1;
                overflow-y: auto;
                padding: 0;
            }

            /* Sembunyikan stats di mobile */
            .route-stats { display: none; }

            /* Route header lebih simple */
            .route-header {
                padding: 10px 12px;
                background: var(--primary);
            }
            .route-title { margin-bottom: 0; }
            .route-title h3 { font-size: 14px; }

            /* Start section mobile */
            .start-section {
                padding: 8px 10px;
                background: var(--gray-100);
            }
            .start-label { display: none; }
            .start-options { margin-bottom: 8px; gap: 6px; }
            .start-opt { flex: 1; justify-content: center; padding: 10px 8px; font-size: 10px; }
            #startManualInput { display: none !important; }
            #startSearchInput { margin-top: 8px; }
            #startSearchInput .start-input { font-size: 16px; padding: 14px; width: 100%; border-radius: 10px; }
            #searchResults { max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
            .search-result-item { padding: 14px; margin-bottom: 8px; border-radius: 10px; }
            .search-result-name { font-size: 14px; }
            .search-result-addr { font-size: 11px; }
            .start-current { margin-top: 6px; }

            /* Action buttons */
            .route-action { padding: 10px; }
            .btn-full { padding: 12px; font-size: 12px; }

            /* Map takes full screen */
            .map-wrap {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 60px;
                z-index: 1;
            }
            #map { height: 100% !important; }

            /* Map controls repositioned */
            .map-ctrls {
                top: 10px;
                right: 10px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 6px;
                max-width: 140px;
                justify-content: flex-end;
            }
            .map-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                border-radius: 8px;
            }

            /* Legend - compact or hidden */
            .legend {
                bottom: 70px;
                right: 10px;
                padding: 8px 10px;
                max-width: 120px;
                font-size: 9px;
            }
            .legend-title { font-size: 9px; margin-bottom: 6px; }
            .legend-item { font-size: 8px; margin-bottom: 3px; gap: 5px; }
            .legend-dot { width: 12px; height: 12px; }

            /* Detail Panel */
            .detail-panel {
                top: auto;
                bottom: 70px;
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 50vh;
            }
            .detail-header { padding: 10px 12px; }
            .detail-header h4 { font-size: 12px; }
            .detail-item { padding: 10px; gap: 8px; }
            .detail-num { width: 28px; height: 28px; font-size: 11px; }
            .detail-name { font-size: 12px; }
            .detail-sub, .detail-from { font-size: 9px; }
            .detail-dist .km { font-size: 13px; }

            /* Popup */
            .leaflet-popup-content { min-width: 220px; }
            .popup-head { padding: 10px 12px; }
            .popup-head h4 { font-size: 13px; }
            .popup-body { padding: 10px 12px; }
            .popup-addr { font-size: 10px; }
            .popup-dist { font-size: 11px; padding: 6px 10px; }
            .popup-btn { padding: 10px; font-size: 11px; }

            /* Toast */
            .toast-wrap { bottom: 70px; }
            .toast { padding: 10px 16px; font-size: 12px; }

            /* Click indicator */
            .click-indicator {
                top: 40%;
                font-size: 12px;
                padding: 10px 16px;
            }

            /* Bottom Navigation */
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: var(--white);
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
                z-index: 3000;
                padding: 0 10px;
                padding-bottom: env(safe-area-inset-bottom);
            }
            .nav-btn {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 4px;
                border: none;
                background: none;
                color: var(--gray-600);
                font-size: 10px;
                font-weight: 600;
                font-family: inherit;
                cursor: pointer;
                transition: all 0.2s;
                position: relative;
            }
            .nav-btn .nav-icon { font-size: 20px; }
            .nav-btn.active { color: var(--accent); }
            .nav-btn.active::after {
                content: '';
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 30px;
                height: 3px;
                background: var(--accent);
                border-radius: 0 0 3px 3px;
            }
            .nav-btn .nav-badge {
                position: absolute;
                top: 6px;
                right: calc(50% - 20px);
                background: var(--accent);
                color: white;
                font-size: 9px;
                padding: 1px 5px;
                border-radius: 8px;
                min-width: 16px;
                text-align: center;
            }

            /* Floating GPS button */
            .mobile-gps-btn {
                position: fixed;
                bottom: 130px;
                right: 10px;
                width: 50px;
                height: 50px;
                background: var(--green);
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 22px;
                box-shadow: 0 4px 15px rgba(6,214,160,0.4);
                z-index: 1500;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .mobile-gps-btn:active { transform: scale(0.95); }

            /* Hide desktop elements on mobile */
            .leaflet-control-zoom { display: none !important; }
        }

        /* Extra small devices */
        @media (max-width: 380px) {
            .stat .num { font-size: 16px; }
            .start-opt { font-size: 8px; padding: 6px; min-width: 60px; }
            .route-btns button { font-size: 9px; padding: 6px 4px; }
            .filter { font-size: 9px; padding: 5px 8px; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Memuat ZUMA Indonesia...</p>
    </div>
    <div class="toast-wrap" id="toasts"></div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <button class="nav-btn active" onclick="mobileShowMap()">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span>Peta</span>
        </button>
        <button class="nav-btn" onclick="mobileShowStores()">
            <span class="nav-icon">üè™</span>
            <span>Toko</span>
        </button>
        <button class="nav-btn" onclick="mobileShowRoute()">
            <span class="nav-icon">üìç</span>
            <span>Rute</span>
            <span class="nav-badge" id="mobileRouteBadge">0</span>
        </button>
    </nav>

    <!-- Mobile GPS Button -->
    <button class="mobile-gps-btn" onclick="setStartMode('gps')" title="Lokasi Saya">üìç</button>

    <div class="app">
        <aside class="sidebar">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon"><img src="https://raw.githubusercontent.com/wafi-netizen/zuma-store-map/main/logo.png" alt="ZUMA"></div>
                    <div>
                        <h1>Zuma Indonesia</h1>
                        <span>Store Mapping & Visit Planner</span>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat"><div class="num">50</div><div class="lbl">Toko</div></div>
                    <div class="stat"><div class="num">7</div><div class="lbl">Cabang</div></div>
                    <div class="stat"><div class="num">15</div><div class="lbl">Kota</div></div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('stores')">üè™ Daftar Toko</button>
                <button class="tab" onclick="switchTab('route')">üó∫Ô∏è Rute<span class="badge" id="routeBadge">0</span></button>
            </div>

            <div class="tab-content active" id="tab-stores">
                <div class="search">
                    <input type="text" id="searchInput" placeholder="Cari toko, kota, atau alamat...">
                    <div class="filters">
                        <button class="filter active" data-f="all">Semua</button>
                        <button class="filter" data-f="Bali">Bali</button>
                        <button class="filter" data-f="Jawa Timur">Jawa Timur</button>
                        <button class="filter" data-f="Jakarta">Jakarta</button>
                        <button class="filter" data-f="Lombok & Nusra">Lombok</button>
                        <button class="filter" data-f="Pekanbaru">Pekanbaru</button>
                        <button class="filter" data-f="Batam & Kepri">Batam</button>
                        <button class="filter" data-f="Sulawesi">Sulawesi</button>
                    </div>
                </div>
                <div class="list" id="storeList"></div>
            </div>

            <div class="tab-content" id="tab-route">
                <div class="route-header">
                    <div class="route-title">
                        <h3>üó∫Ô∏è Rute Kunjungan</h3>
                        <div class="route-btns">
                            <button onclick="autoSort()">üîÑ Sort</button>
                            <button onclick="clearRoute()">üóëÔ∏è Reset</button>
                            <button onclick="exportCSV()">üì§ Export</button>
                        </div>
                    </div>
                    <div class="route-stats">
                        <div class="route-stat">
                            <span class="icon">üìç</span>
                            <div>
                                <div class="val" id="rCount">0</div>
                                <div class="lbl">Toko</div>
                            </div>
                        </div>
                        <div class="route-stat">
                            <span class="icon">üöó</span>
                            <div>
                                <div class="val" id="rDist">0</div>
                                <div class="lbl">km total</div>
                            </div>
                        </div>
                        <div class="route-stat">
                            <span class="icon">‚è±Ô∏è</span>
                            <div>
                                <div class="val" id="rTime">0</div>
                                <div class="lbl">jam</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Start Point Selector -->
                <div class="start-section">
                    <div class="start-label">üìç Titik Mulai (Hotel/Lokasi Anda)</div>
                    <div class="start-options">
                        <button class="start-opt active" onclick="setStartMode('auto')">üîÑ Bandara</button>
                        <button class="start-opt" onclick="setStartMode('gps')">üìç Lokasi Saya</button>
                        <button class="start-opt" onclick="setStartMode('search')">üîç Cari Lokasi</button>
                    </div>
                    <div id="startSearchInput" style="display:none; margin-top:8px;">
                        <input type="text" class="start-input" id="searchLocation" placeholder="Ketik alamat/nama tempat..." oninput="onSearchInput(this.value)" autocomplete="off">
                        <div id="searchResults"></div>
                    </div>
                    <div id="startCurrent" class="start-current" style="display:none;">
                        <span>üìç</span>
                        <div>
                            <div id="startCurrentName">Hotel</div>
                            <div class="coords" id="startCurrentCoords">-8.123, 115.456</div>
                        </div>
                        <button class="clear-btn" onclick="clearCustomStart()">‚úï</button>
                    </div>
                </div>

                <div class="route-list-container">
                    <div class="route-chips" id="routeChips">
                        <div class="chip start">‚úàÔ∏è Bandara</div>
                    </div>
                </div>
                <div class="route-action">
                    <button class="btn-full primary" onclick="calcRoute()">üß≠ Hitung Rute Optimal</button>
                    <button class="btn-full secondary" onclick="openGMaps()">üìç Buka di Google Maps</button>
                </div>
            </div>
        </aside>

        <main class="map-wrap">
            <div id="map"></div>
            <div class="click-indicator">Klik di peta untuk set titik mulai...</div>

            <div class="detail-panel" id="detailPanel">
                <div class="detail-header">
                    <h4>üìã Detail Rute</h4>
                    <button class="detail-close" onclick="closeDetail()">‚úï</button>
                </div>
                <div class="detail-list" id="detailList"></div>
            </div>

            <div class="map-ctrls">
                <button class="map-btn" onclick="fitAll()" title="Lihat Semua">üó∫Ô∏è</button>
                <button class="map-btn" onclick="focusBranch('Bali')" title="Bali">üèùÔ∏è</button>
                <button class="map-btn" onclick="focusBranch('Jawa Timur')" title="Jawa Timur">üè≠</button>
                <button class="map-btn" onclick="focusBranch('Jakarta')" title="Jakarta">üèôÔ∏è</button>
                <button class="map-btn" onclick="toggleSat()" id="satBtn" title="Satelit">üõ∞Ô∏è</button>
                <button class="map-btn" onclick="setStartMode('gps')" title="Lokasi Saya">üìç</button>
            </div>

            <div class="legend">
                <div class="legend-title">Cabang ZUMA</div>
                <div class="legend-item"><div class="legend-dot bali"></div>Bali (29)</div>
                <div class="legend-item"><div class="legend-dot jatim"></div>Jawa Timur (11)</div>
                <div class="legend-item"><div class="legend-dot jakarta"></div>Jakarta (4)</div>
                <div class="legend-item"><div class="legend-dot lombok"></div>Lombok (2)</div>
                <div class="legend-item"><div class="legend-dot pekanbaru"></div>Pekanbaru (1)</div>
                <div class="legend-item"><div class="legend-dot batam"></div>Batam (2)</div>
                <div class="legend-item"><div class="legend-dot sulawesi"></div>Sulawesi (1)</div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
// CONFIG - Ganti dengan URL Google Apps Script kamu
const API_URL = ''; // Kosongkan untuk pakai data lokal, isi dengan URL Apps Script untuk pakai Spreadsheet

// DATA (default - akan di-overwrite jika API_URL diisi)
let stores = [
    {id:1,name:"Zuma Tanah Lot",branch:"Bali",area:"Bali 1",city:"Tabanan",address:"Jl. Tanah Lot, Desa Beraban, Kec. Kediri",lat:-8.6211,lng:115.0868},
    {id:2,name:"Zuma Dalung",branch:"Bali",area:"Bali 2",city:"Badung",address:"Jl. Raya Padang Luwih No. 208A, Dalung",lat:-8.6362,lng:115.1668},
    {id:3,name:"Zuma Mall Bali Galeria",branch:"Bali",area:"Bali 3",city:"Badung",address:"Jl. By Pass Ngurah Rai, Kuta",lat:-8.7275,lng:115.1893},
    {id:4,name:"Zuma Tabanan",branch:"Bali",area:"Bali 1",city:"Tabanan",address:"Jl. Dr. Ir. Soekarno No. 768, Banjar Anyar",lat:-8.5430,lng:115.1247},
    {id:5,name:"Zuma Panjer",branch:"Bali",area:"Bali 3",city:"Denpasar",address:"Jl. Tukad Barito No.80, Panjer",lat:-8.6968,lng:115.2252},
    {id:6,name:"Zuma Kesiman",branch:"Bali",area:"Bali 3",city:"Denpasar",address:"Jl. WR Supratman 108-172, Kesiman",lat:-8.6593,lng:115.2593},
    {id:7,name:"Zuma Penatih",branch:"Bali",area:"Bali 1",city:"Denpasar",address:"Jl. Trengguli No. 107, Penatih",lat:-8.6413,lng:115.2578},
    {id:8,name:"Zuma Peliatan",branch:"Bali",area:"Bali 3",city:"Gianyar",address:"Jl. Cok Gede Rai No. 13, Peliatan, Ubud",lat:-8.5159,lng:115.2784},
    {id:9,name:"Zuma Batubulan",branch:"Bali",area:"Bali 1",city:"Gianyar",address:"Jl. Raya Batubulan No. 10, Sukawati",lat:-8.6013,lng:115.2706},
    {id:10,name:"Zuma Monkey Forest",branch:"Bali",area:"Bali 1",city:"Gianyar",address:"Jl. Monkey Forest No. 15, Ubud",lat:-8.5177,lng:115.2588},
    {id:11,name:"Zuma Klungkung",branch:"Bali",area:"Bali 2",city:"Klungkung",address:"Jl. Flamboyan, Semarapura Kauh",lat:-8.5391,lng:115.4046},
    {id:12,name:"Zuma Singaraja",branch:"Bali",area:"Bali 3",city:"Buleleng",address:"Jl. Ahmad Yani Barat No. 202",lat:-8.1121,lng:115.0879},
    {id:13,name:"Zuma Karangasem",branch:"Bali",area:"Bali 2",city:"Karangasem",address:"Jl. Untung Surapati, Padang Kerta",lat:-8.4515,lng:115.6076},
    {id:14,name:"Zuma Bajra",branch:"Bali",area:"Bali 1",city:"Tabanan",address:"Jl. Bajera, Selemadeg",lat:-8.4742,lng:114.9892},
    {id:15,name:"Zuma Jembrana",branch:"Bali",area:"Bali 1",city:"Jembrana",address:"Jl. Ngurah Rai No. 113, Pendem",lat:-8.3589,lng:114.6319},
    {id:16,name:"Zuma Monang Maning",branch:"Bali",area:"Bali 1",city:"Denpasar",address:"Jl. Gunung Rinjani No. 7-8, Tegal Harum",lat:-8.6516,lng:115.2052},
    {id:17,name:"Zuma Pemogan",branch:"Bali",area:"Bali 2",city:"Denpasar",address:"Jl. Raya Pemogan No. 7",lat:-8.7133,lng:115.2154},
    {id:18,name:"Zuma Peguyangan",branch:"Bali",area:"Bali 2",city:"Denpasar",address:"Jl. Ahmad Yani Utara No. 105",lat:-8.6233,lng:115.2189},
    {id:19,name:"Zuma Level 21",branch:"Bali",area:"Bali 1",city:"Denpasar",address:"Jl. Teuku Umar No. 1, Dauh Puri Klod",lat:-8.6674,lng:115.2116},
    {id:20,name:"Zuma Kedonganan",branch:"Bali",area:"Bali 3",city:"Badung",address:"Jl. Uluwatu No. 59, Kedonganan",lat:-8.7594,lng:115.1668},
    {id:21,name:"Zuma Lippo Bali",branch:"Bali",area:"Bali 2",city:"Badung",address:"Jl. Sunset Road No. 10, Kuta",lat:-8.7107,lng:115.1756},
    {id:22,name:"Zuma Gianyar",branch:"Bali",area:"Bali 2",city:"Gianyar",address:"Jl. By Pass Dharma Giri No. 18B",lat:-8.5414,lng:115.3238},
    {id:23,name:"Zuma Seririt",branch:"Bali",area:"Bali 3",city:"Buleleng",address:"Jl. Sudirman, Tangguwisia",lat:-8.1857,lng:114.9406},
    {id:24,name:"Zuma Living World",branch:"Bali",area:"Bali 2",city:"Denpasar",address:"Jl. Gatot Subroto Timur, Tonja",lat:-8.6332,lng:115.2357},
    {id:25,name:"Zuma Uluwatu",branch:"Bali",area:"Bali 3",city:"Badung",address:"Jl Raya Uluwatu 88 blok C, Ungasan",lat:-8.8233,lng:115.1272},
    {id:26,name:"Zuma Kapal",branch:"Bali",area:"Bali 1",city:"Badung",address:"Jl. Raya Denpasar-Gilimanuk No.14",lat:-8.5831,lng:115.1579},
    {id:27,name:"Zuma Icon Bali",branch:"Bali",area:"Bali 2",city:"Denpasar",address:"Jl. Danau Tamblingan No.27, Sanur",lat:-8.6988,lng:115.2606},
    {id:28,name:"Zuma Lebah Peliatan",branch:"Bali",area:"Bali 3",city:"Gianyar",address:"Jl. Yudistira, Br Kalah No.1, Ubud",lat:-8.5081,lng:115.2819},
    {id:29,name:"Zuma Bangli",branch:"Bali",area:"Bali 2",city:"Bangli",address:"Jl. Tirta Geduh, Bebalang",lat:-8.4545,lng:115.3545},
    {id:30,name:"Zuma Matos",branch:"Jawa Timur",area:"Jawa Timur",city:"Malang",address:"Jl. Veteran No. 2, Klojen",lat:-7.9786,lng:112.6311},
    {id:31,name:"Zuma Lippo Batu",branch:"Jawa Timur",area:"Jawa Timur",city:"Batu",address:"Jl. Diponegoro No. 1, Sisir",lat:-7.8746,lng:112.5247},
    {id:32,name:"Zuma Lippo Sidoarjo",branch:"Jawa Timur",area:"Jawa Timur",city:"Sidoarjo",address:"Jl. Jati Raya No. 1",lat:-7.4478,lng:112.7183},
    {id:33,name:"Zuma Tunjungan Plaza",branch:"Jawa Timur",area:"Jawa Timur",city:"Surabaya",address:"Jl. Basuki Rachmat No. 8-12",lat:-7.2614,lng:112.7378},
    {id:34,name:"Zuma Galaxy Mall",branch:"Jawa Timur",area:"Jawa Timur",city:"Surabaya",address:"Jl. Dharmahusada Indah Timur",lat:-7.2756,lng:112.7814},
    {id:35,name:"Zuma PTC",branch:"Jawa Timur",area:"Jawa Timur",city:"Surabaya",address:"Jl. Raya Lontar No. 2, Wiyung",lat:-7.3011,lng:112.6947},
    {id:36,name:"Zuma Royal Plaza",branch:"Jawa Timur",area:"Jawa Timur",city:"Surabaya",address:"Jl. A Yani No. 16-18, Wonokromo",lat:-7.3156,lng:112.7378},
    {id:37,name:"Zuma MOG",branch:"Jawa Timur",area:"Jawa Timur",city:"Malang",address:"Jl. Kawi No.24, Kauman",lat:-7.9811,lng:112.6256},
    {id:38,name:"Zuma Sunrise Mall",branch:"Jawa Timur",area:"Jawa Timur",city:"Mojokerto",address:"Jl. Benteng Pancasila No.9",lat:-7.4719,lng:112.4336},
    {id:39,name:"Zuma CITO",branch:"Jawa Timur",area:"Jawa Timur",city:"Surabaya",address:"Jl. Ahmad Yani No.288, Gayungan",lat:-7.3389,lng:112.7306},
    {id:40,name:"Zuma Icon Gresik",branch:"Jawa Timur",area:"Jawa Timur",city:"Gresik",address:"Jl. Wahidin Sudirohusodo No.788",lat:-7.1622,lng:112.6508},
    {id:41,name:"Zuma Lippo Mall Puri",branch:"Jakarta",area:"Jakarta",city:"Jakarta Barat",address:"Jl. Puri Indah Raya, Kembangan",lat:-6.1872,lng:106.7347},
    {id:42,name:"Zuma MOI",branch:"Jakarta",area:"Jakarta",city:"Jakarta Utara",address:"Jl. Boulevard Bar. Raya, Kelapa Gading",lat:-6.1486,lng:106.8933},
    {id:43,name:"Zuma Pluit Village",branch:"Jakarta",area:"Jakarta",city:"Jakarta Utara",address:"Jl. Pluit Indah No. 12, Penjaringan",lat:-6.1236,lng:106.7972},
    {id:44,name:"Zuma Bintaro Exchange",branch:"Jakarta",area:"Jakarta",city:"Tangerang Selatan",address:"Jl. Sektor VII No.2, Pondok Aren",lat:-6.2811,lng:106.7167},
    {id:45,name:"Zuma Epicentrum",branch:"Lombok & Nusra",area:"Lombok & Nusra",city:"Mataram",address:"Lombok Epicentrum Mall, Jl. Sriwijaya",lat:-8.5833,lng:116.1167},
    {id:46,name:"Zuma Mataram",branch:"Lombok & Nusra",area:"Lombok & Nusra",city:"Mataram",address:"Jl. Caturwarga No 2, Pajang Timur",lat:-8.5892,lng:116.0956},
    {id:47,name:"Zuma SKA Mall",branch:"Pekanbaru",area:"Pekanbaru",city:"Pekanbaru",address:"Jl. Soekarno-Hatta No.114, Delima",lat:0.4697,lng:101.4083},
    {id:48,name:"Zuma Nagoya Hills",branch:"Batam & Kepri",area:"Batam & Kepri",city:"Batam",address:"Jl. Teuku Umar, Nagoya",lat:1.1386,lng:104.0167},
    {id:49,name:"Zuma K Square",branch:"Batam & Kepri",area:"Batam & Kepri",city:"Batam",address:"Jl. Sudirman No.25-35, Sukajadi",lat:1.1253,lng:104.0489},
    {id:50,name:"Zuma Mega Mall",branch:"Sulawesi",area:"Sulawesi",city:"Manado",address:"Jl. Piere Tendean Boulevard, Megamas",lat:1.4689,lng:124.8425}
];

let warehouses = [];

let refs = {
    "Bali": { name: "Bandara Ngurah Rai", lat: -8.7467, lng: 115.1672 },
    "Jawa Timur": { name: "Bandara Juanda", lat: -7.3797, lng: 112.7869 },
    "Jakarta": { name: "Bandara Soekarno-Hatta", lat: -6.1256, lng: 106.6558 },
    "Lombok & Nusra": { name: "Bandara Lombok", lat: -8.7573, lng: 116.2769 },
    "Pekanbaru": { name: "Bandara SSK II", lat: 0.4606, lng: 101.4456 },
    "Batam & Kepri": { name: "Bandara Hang Nadim", lat: 1.1211, lng: 104.1186 },
    "Sulawesi": { name: "Bandara Sam Ratulangi", lat: 1.5492, lng: 124.9261 }
};

const colors = {"Bali":"#2a9d8f","Jawa Timur":"#1565c0","Jakarta":"#7b1fa2","Lombok & Nusra":"#ef6c00","Pekanbaru":"#f4a261","Batam & Kepri":"#06d6a0","Sulawesi":"#e94560","Warehouse":"#ff5722"};

// State
let map, markers = [], routeCtrl = null, routeLines = [], satLayer, defLayer, isSat = false;
let filter = 'all';
let route = []; // Simple array of store IDs

// Custom start point state
let customStart = null; // { name: "Hotel XYZ", lat: -8.123, lng: 115.456 }
let startMode = 'auto'; // 'auto', 'gps', 'click', 'manual'
let clickModeActive = false;
let customStartMarker = null;

// Init
document.addEventListener('DOMContentLoaded', init);

async function init() {
    // Fetch data from API if configured
    if (API_URL) {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            if (data.stores && data.stores.length > 0) {
                stores = data.stores;
            }
            if (data.warehouses && data.warehouses.length > 0) {
                warehouses = data.warehouses;
            }
            if (data.airports && Object.keys(data.airports).length > 0) {
                refs = data.airports;
            }
            console.log('Data loaded from API:', { stores: stores.length, warehouses: warehouses.length });
        } catch (err) {
            console.error('Failed to fetch data from API, using local data:', err);
        }
    }

    initMap();
    setupEvents();
    load();
    render();
    setTimeout(() => document.getElementById('loading').classList.add('hidden'), 600);
}

function initMap() {
    map = L.map('map', { center: [-2.5, 118], zoom: 5, zoomControl: false });
    L.control.zoom({ position: 'bottomleft' }).addTo(map);
    defLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
    satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
    addMarkers();

    // Map click handler for setting custom start
    map.on('click', onMapClick);
}

function onMapClick(e) {
    if (!clickModeActive) return;

    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // Set custom start point
    setCustomStart('Lokasi Dipilih', lat, lng);

    // Exit click mode
    clickModeActive = false;
    document.querySelector('.app').classList.remove('click-mode-active');

    toast('Titik mulai diset!', 'success');
}

function setupEvents() {
    document.getElementById('searchInput').addEventListener('input', e => renderList(filter, e.target.value));
    document.querySelectorAll('.filter').forEach(b => b.addEventListener('click', () => {
        document.querySelectorAll('.filter').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        filter = b.dataset.f;
        renderList(filter, document.getElementById('searchInput').value);
    }));

    // Make chips sortable - ONLY on desktop
    if (window.innerWidth > 768) {
        new Sortable(document.getElementById('routeChips'), {
            animation: 150,
            filter: '.start',
            onEnd: () => {
                const chips = document.querySelectorAll('#routeChips .chip[data-id]');
                route = Array.from(chips).map(c => parseInt(c.dataset.id));
                updateRoute();
            }
        });
    }
}

// Start Point Functions
function setStartMode(mode) {
    startMode = mode;

    // Update UI
    document.querySelectorAll('.start-opt').forEach(b => b.classList.remove('active'));
    document.querySelector(`.start-opt[onclick*="${mode}"]`)?.classList.add('active');

    // Hide manual input by default (if exists)
    const manualInput = document.getElementById('startManualInput');
    if (manualInput) manualInput.style.display = 'none';

    // Exit click mode if active
    if (clickModeActive && mode !== 'click') {
        clickModeActive = false;
        document.querySelector('.app').classList.remove('click-mode-active');
    }

    // Hide search input by default
    const searchInput = document.getElementById('startSearchInput');
    if (searchInput) searchInput.style.display = 'none';

    switch(mode) {
        case 'auto':
            clearCustomStart();
            break;
        case 'gps':
            getGPSLocation();
            break;
        case 'search':
            if (searchInput) searchInput.style.display = 'block';
            document.getElementById('searchLocation')?.focus();
            break;
    }
}

// Search location with autocomplete (debounced)
let searchTimeout = null;

function onSearchInput(query) {
    const resultsDiv = document.getElementById('searchResults');

    // Clear previous timeout
    if (searchTimeout) clearTimeout(searchTimeout);

    // Clear results if query too short
    if (query.trim().length < 3) {
        resultsDiv.innerHTML = '';
        return;
    }

    // Show loading
    resultsDiv.innerHTML = '<div class="search-loading">Mencari...</div>';

    // Debounce: wait 400ms after user stops typing
    searchTimeout = setTimeout(() => {
        searchLocation(query.trim());
    }, 400);
}

async function searchLocation(query) {
    const resultsDiv = document.getElementById('searchResults');

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=id&limit=8`);
        const results = await response.json();

        if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="search-no-result">Tidak ditemukan. Coba kata kunci lain.</div>';
            return;
        }

        resultsDiv.innerHTML = results.map(r => `
            <div class="search-result-item" onclick="selectSearchResult('${r.display_name.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                <div class="search-result-name">${r.display_name.split(',')[0]}</div>
                <div class="search-result-addr">${r.display_name}</div>
            </div>
        `).join('');
    } catch (err) {
        resultsDiv.innerHTML = '<div class="search-no-result">Gagal mencari. Coba lagi.</div>';
    }
}

function selectSearchResult(name, lat, lng) {
    const shortName = name.split(',')[0];
    setCustomStart(shortName, parseFloat(lat), parseFloat(lng));
    map.setView([lat, lng], 14);
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchLocation').value = '';
    document.getElementById('startSearchInput').style.display = 'none';
    toast('Lokasi dipilih: ' + shortName, 'success');

    // On mobile, close sidebar and show map
    if (window.innerWidth <= 768) {
        mobileShowMap();
    }
}

function getGPSLocation() {
    if (!navigator.geolocation) {
        toast('GPS tidak didukung di browser ini', 'error');
        return;
    }

    toast('Mencari lokasi...', '');

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            setCustomStart('Lokasi Saya', lat, lng);
            map.setView([lat, lng], 14);
            toast('Lokasi ditemukan!', 'success');
        },
        (err) => {
            toast('Gagal mendapatkan lokasi: ' + err.message, 'error');
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function enableClickMode() {
    clickModeActive = true;
    document.querySelector('.app').classList.add('click-mode-active');
    toast('Klik di peta untuk memilih titik mulai', '');
}

function applyManualStart() {
    const name = document.getElementById('startName').value || 'Lokasi Custom';
    const lat = parseFloat(document.getElementById('startLat').value);
    const lng = parseFloat(document.getElementById('startLng').value);

    if (isNaN(lat) || isNaN(lng)) {
        toast('Masukkan koordinat yang valid', 'error');
        return;
    }

    setCustomStart(name, lat, lng);
    map.setView([lat, lng], 14);
    toast('Titik mulai diset!', 'success');
}

function setCustomStart(name, lat, lng) {
    customStart = { name, lat, lng };

    // Update UI
    document.getElementById('startCurrent').style.display = 'flex';
    document.getElementById('startCurrentName').textContent = name;
    document.getElementById('startCurrentCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

    // Add/update marker on map
    if (customStartMarker) {
        map.removeLayer(customStartMarker);
    }

    const icon = L.divIcon({
        className: '',
        html: `<div style="background:#06d6a0;border:3px solid white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;color:white;font-size:16px;box-shadow:0 4px 12px rgba(0,0,0,0.3)">üìç</div>`,
        iconSize: [36, 36], iconAnchor: [18, 18]
    });

    customStartMarker = L.marker([lat, lng], { icon }).addTo(map)
        .bindPopup(`<div class="popup-head" style="background:linear-gradient(135deg,#06d6a0,#05c491)"><h4>üìç ${name}</h4><span>Titik Mulai Custom</span></div><div class="popup-body"><p class="popup-addr">${lat.toFixed(6)}, ${lng.toFixed(6)}</p></div>`);

    // Update route display
    updateRoute();
    save();
}

function clearCustomStart() {
    customStart = null;
    startMode = 'auto';

    // Update UI
    document.getElementById('startCurrent').style.display = 'none';
    document.querySelectorAll('.start-opt').forEach(b => b.classList.remove('active'));
    document.querySelector('.start-opt[onclick*="auto"]').classList.add('active');
    const manualEl = document.getElementById('startManualInput');
    if (manualEl) manualEl.style.display = 'none';

    // Remove marker
    if (customStartMarker) {
        map.removeLayer(customStartMarker);
        customStartMarker = null;
    }

    // Exit click mode
    clickModeActive = false;
    document.querySelector('.app').classList.remove('click-mode-active');

    updateRoute();
    save();
}

// Get current start point (custom or auto from airport)
function getStartPoint() {
    if (customStart) {
        return customStart;
    }

    // Auto: get airport based on first store in route
    if (route.length > 0) {
        const first = stores.find(s => s.id === route[0]);
        const ref = refs[first?.branch];
        if (ref) return ref;
    }

    // Default: based on current filter or Bali
    if (filter !== 'all' && refs[filter]) {
        return refs[filter];
    }

    // Default to Bali
    return refs["Bali"];
}

// Utils
function dist(lat1, lng1, lat2, lng2) {
    const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLng = (lng2-lng1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function toast(msg, type='') {
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    el.textContent = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

function getShortName(name) { return name.replace('Zuma ', '').replace('Bandara ', ''); }
function getBadgeClass(branch) { return branch.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-'); }

// Map
function mkIcon(branch, num = null, inRoute = false) {
    let c = colors[branch] || '#2a9d8f';
    if (inRoute) c = '#f4a261';
    const txt = num !== null ? num : '';
    return L.divIcon({
        className: '',
        html: `<div style="background:${c};border:3px solid white;border-radius:50%;width:${num?28:24}px;height:${num?28:24}px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:${num?12:10}px;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-family:sans-serif">${txt}</div>`,
        iconSize: [num?28:24, num?28:24],
        iconAnchor: [num?14:12, num?14:12]
    });
}

function addMarkers() {
    // Add airport markers
    Object.entries(refs).forEach(([br, pt]) => {
        const icon = L.divIcon({
            className: '',
            html: `<div style="background:#e94560;border:3px solid white;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;color:white;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3)">‚úà</div>`,
            iconSize: [30, 30], iconAnchor: [15, 15]
        });
        L.marker([pt.lat, pt.lng], { icon }).addTo(map)
            .bindPopup(`<div class="popup-head"><h4>‚úàÔ∏è ${pt.name}</h4><span>Titik Referensi ${br}</span></div>`);
    });

    // Add store markers
    stores.forEach(s => {
        const inRoute = route.includes(s.id);
        const idx = route.indexOf(s.id);
        const marker = L.marker([s.lat, s.lng], { icon: mkIcon(s.branch, idx > -1 ? idx + 1 : null, inRoute) }).addTo(map);
        marker.data = s;
        marker.on('click', () => showStorePopup(s));
        markers.push(marker);
    });
}

function updateMarkers() {
    markers.forEach(m => {
        const s = m.data;
        const inRoute = route.includes(s.id);
        const idx = route.indexOf(s.id);
        m.setIcon(mkIcon(s.branch, idx > -1 ? idx + 1 : null, inRoute));
    });
}

function showStorePopup(s) {
    const startPt = getStartPoint();
    const distFromStart = startPt ? dist(startPt.lat, startPt.lng, s.lat, s.lng) : 0;
    const inRoute = route.includes(s.id);

    // Get distance from previous store in route
    let distFromPrev = null;
    let prevName = null;
    if (inRoute) {
        const idx = route.indexOf(s.id);
        if (idx === 0 && startPt) {
            distFromPrev = distFromStart;
            prevName = getShortName(startPt.name);
        } else if (idx > 0) {
            const prevStore = stores.find(x => x.id === route[idx - 1]);
            if (prevStore) {
                distFromPrev = dist(prevStore.lat, prevStore.lng, s.lat, s.lng);
                prevName = getShortName(prevStore.name);
            }
        }
    }

    const startLabel = customStart ? 'Titik Mulai' : 'Bandara';

    const popup = L.popup({ maxWidth: 280 })
        .setLatLng([s.lat, s.lng])
        .setContent(`
            <div class="popup-head">
                <h4>${s.name}</h4>
                <span>${s.area} ‚Ä¢ ${s.city}</span>
            </div>
            <div class="popup-body">
                <p class="popup-addr">${s.address}</p>
                <div class="popup-dist">
                    <span class="icon">üìç</span>
                    <span>Jarak dari ${startLabel}: <span class="value">${distFromStart.toFixed(1)} km</span></span>
                </div>
                ${distFromPrev !== null ? `
                <div class="popup-dist" style="background:#fff3e0;">
                    <span class="icon">üöó</span>
                    <span>Dari ${prevName}: <span class="value">${distFromPrev.toFixed(1)} km</span></span>
                </div>
                ` : ''}
                <button class="popup-btn" onclick="${inRoute ? `rmRoute(${s.id})` : `addToRoute(${s.id})`}">
                    ${inRoute ? '‚úï Hapus dari Rute' : '+ Tambah ke Rute'}
                </button>
            </div>
        `)
        .openOn(map);
}

// Route Lines
function clearRouteLines() {
    routeLines.forEach(l => map.removeLayer(l));
    routeLines = [];
    if (routeCtrl) { map.removeControl(routeCtrl); routeCtrl = null; }
}

function drawRouteLine() {
    clearRouteLines();
    if (route.length === 0) return;

    const startPt = getStartPoint();
    if (!startPt) return;

    const points = [[startPt.lat, startPt.lng]];
    route.forEach(id => {
        const s = stores.find(x => x.id === id);
        if (s) points.push([s.lat, s.lng]);
    });

    // Draw polyline
    const line = L.polyline(points, {
        color: customStart ? '#06d6a0' : '#e94560',
        weight: 4,
        opacity: 0.8,
        dashArray: '10, 10'
    }).addTo(map);
    routeLines.push(line);
}

// Render
function render() {
    renderList(filter, '');
    updateRoute();
}

function renderList(f = 'all', q = '') {
    const el = document.getElementById('storeList');
    let list = stores;
    if (f !== 'all') list = list.filter(s => s.branch === f);
    if (q) {
        const t = q.toLowerCase();
        list = list.filter(s => s.name.toLowerCase().includes(t) || s.address.toLowerCase().includes(t) || s.city.toLowerCase().includes(t));
    }

    const startPt = getStartPoint();

    el.innerHTML = list.map(s => {
        const d = startPt ? dist(startPt.lat, startPt.lng, s.lat, s.lng) : 0;
        const inRoute = route.includes(s.id);
        const routeIdx = route.indexOf(s.id);
        const badgeCls = getBadgeClass(s.branch);
        const distLabel = customStart ? 'lokasi kamu' : 'bandara';

        return `
        <div class="card ${inRoute ? 'in-route' : ''}" onclick="${inRoute ? `rmRoute(${s.id})` : `addToRoute(${s.id})`}">
            <div class="card-head">
                <span class="card-name">${inRoute ? `<span style="color:var(--gold);margin-right:4px">‚úì</span>` : ''}${s.name}</span>
                <span class="badge ${badgeCls}">${s.area}</span>
            </div>
            <div class="card-loc">${s.city}</div>
            <p class="card-addr">${s.address}</p>
            <div class="card-meta">
                <span>üìç ${d.toFixed(1)} km dari ${distLabel}</span>
            </div>
            <div class="card-actions">
                <button class="btn btn-gray" onclick="event.stopPropagation(); focusStore(${s.id})">üëÅÔ∏è Lihat</button>
                <button class="btn ${inRoute ? 'btn-primary' : 'btn-gold'}" onclick="event.stopPropagation(); ${inRoute ? `rmRoute(${s.id})` : `addToRoute(${s.id})`}">
                    ${inRoute ? '‚úï Hapus' : '+ Tambah'}
                </button>
            </div>
        </div>`;
    }).join('');
}

function updateRoute() {
    const startPt = getStartPoint();
    const isCustom = !!customStart;

    // Update chips with detailed info
    const chipsEl = document.getElementById('routeChips');
    let chipsHtml = '';

    if (startPt) {
        const icon = isCustom ? 'üìç' : '‚úà';
        const chipClass = isCustom ? 'chip start custom' : 'chip start';
        chipsHtml = `
            <div class="${chipClass}" onclick="switchTab('route')">
                <span class="num">${icon}</span>
                <div class="info">
                    <div class="name">${startPt.name}</div>
                    <div class="dist">Titik Mulai${isCustom ? ' (Custom)' : ''}</div>
                </div>
            </div>`;
    } else {
        chipsHtml = `
            <div class="chip start">
                <span class="num">‚úà</span>
                <div class="info">
                    <div class="name">Bandara</div>
                    <div class="dist">Titik Mulai</div>
                </div>
            </div>`;
    }

    let prevLat = startPt?.lat, prevLng = startPt?.lng, prevName = startPt ? getShortName(startPt.name) : 'Bandara';

    route.forEach((id, idx) => {
        const s = stores.find(x => x.id === id);
        if (s) {
            let distFromPrev = 0;
            if (prevLat !== null && prevLat !== undefined) {
                distFromPrev = dist(prevLat, prevLng, s.lat, s.lng);
            }

            chipsHtml += `
                <div class="chip" data-id="${s.id}">
                    <span class="num">${idx + 1}</span>
                    <div class="info">
                        <div class="name">${getShortName(s.name)}</div>
                        <div class="dist">${distFromPrev.toFixed(1)} km dari ${prevName}</div>
                    </div>
                    <span class="remove" onclick="event.stopPropagation(); rmRoute(${s.id})">‚úï</span>
                </div>`;

            prevLat = s.lat;
            prevLng = s.lng;
            prevName = getShortName(s.name);
        }
    });

    chipsEl.innerHTML = chipsHtml;

    // Update stats
    let totalDist = 0;
    prevLat = startPt?.lat;
    prevLng = startPt?.lng;

    route.forEach(id => {
        const s = stores.find(x => x.id === id);
        if (s && prevLat !== null && prevLat !== undefined) {
            totalDist += dist(prevLat, prevLng, s.lat, s.lng);
            prevLat = s.lat;
            prevLng = s.lng;
        }
    });

    const totalTime = (totalDist / 40) + (route.length * 0.25);

    document.getElementById('rCount').textContent = route.length;
    document.getElementById('rDist').textContent = totalDist.toFixed(0);
    document.getElementById('rTime').textContent = totalTime.toFixed(1);
    document.getElementById('routeBadge').textContent = route.length;

    // Update markers
    updateMarkers();

    // Draw route line
    drawRouteLine();

    // Re-init sortable - ONLY on desktop (disable on mobile for better scroll)
    if (window.innerWidth > 768) {
        new Sortable(document.getElementById('routeChips'), {
            animation: 150,
            filter: '.start',
            onEnd: () => {
                const chips = document.querySelectorAll('#routeChips .chip[data-id]');
                route = Array.from(chips).map(c => parseInt(c.dataset.id));
                updateRoute();
                toast('Urutan diperbarui', 'success');
            }
        });
    }
}

// Actions
function switchTab(t) {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelector(`.tab[onclick*="${t}"]`).classList.add('active');
    document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.add('active');
}

function addToRoute(id) {
    if (route.includes(id)) {
        toast('Toko sudah ada di rute', 'error');
        return;
    }
    route.push(id);
    render();
    save();
    toast('Ditambahkan ke rute', 'success');
}

function rmRoute(id) {
    route = route.filter(x => x !== id);
    render();
    save();
    toast('Dihapus dari rute', 'success');
    map.closePopup();
}

function clearRoute() {
    if (!confirm('Hapus semua rute?')) return;
    route = [];
    render();
    save();
    toast('Rute dihapus', 'success');
}

function autoSort() {
    if (route.length < 2) { toast('Minimal 2 toko', 'error'); return; }

    const startPt = getStartPoint();
    if (!startPt) { toast('Titik mulai tidak ditemukan', 'error'); return; }

    const optimized = [];
    const remaining = [...route];
    let lat = startPt.lat, lng = startPt.lng;

    while (remaining.length) {
        let nearIdx = 0, nearDist = Infinity;
        remaining.forEach((id, i) => {
            const s = stores.find(x => x.id === id);
            if (s) {
                const d = dist(lat, lng, s.lat, s.lng);
                if (d < nearDist) { nearDist = d; nearIdx = i; }
            }
        });
        const nid = remaining.splice(nearIdx, 1)[0];
        optimized.push(nid);
        const ns = stores.find(x => x.id === nid);
        if (ns) { lat = ns.lat; lng = ns.lng; }
    }

    route = optimized;
    render();
    save();
    toast('Rute dioptimasi', 'success');
}

function calcRoute() {
    if (!route.length) { toast('Tambahkan toko dulu', 'error'); return; }

    clearRouteLines();

    const startPt = getStartPoint();
    if (!startPt) { toast('Titik mulai tidak ditemukan', 'error'); return; }

    const waypoints = [L.latLng(startPt.lat, startPt.lng)];
    route.forEach(id => {
        const s = stores.find(x => x.id === id);
        if (s) waypoints.push(L.latLng(s.lat, s.lng));
    });

    routeCtrl = L.Routing.control({
        waypoints,
        routeWhileDragging: false,
        addWaypoints: false,
        show: false,
        lineOptions: {
            styles: [
                { color: customStart ? '#06d6a0' : '#e94560', opacity: 0.9, weight: 5 },
                { color: '#f4a261', opacity: 1, weight: 3 }
            ]
        },
        createMarker: () => null
    }).addTo(map);

    routeCtrl.on('routesfound', e => {
        const r = e.routes[0];
        document.getElementById('rDist').textContent = (r.summary.totalDistance / 1000).toFixed(0);
        document.getElementById('rTime').textContent = (r.summary.totalTime / 3600).toFixed(1);
        showDetailPanel();
    });

    map.fitBounds(L.latLngBounds(waypoints), { padding: [80, 80] });
    toast('Rute dihitung', 'success');
}

function showDetailPanel() {
    const startPt = getStartPoint();
    const isCustom = !!customStart;

    const iconClass = isCustom ? 'start custom' : 'start';
    const icon = isCustom ? 'üìç' : '‚úà';

    let html = `
        <div class="detail-item ${iconClass}" onclick="map.setView([${startPt?.lat}, ${startPt?.lng}], 14)">
            <div class="detail-num ${iconClass}">${icon}</div>
            <div class="detail-info">
                <div class="detail-name">${startPt?.name || 'Bandara'}</div>
                <div class="detail-sub">Titik Mulai${isCustom ? ' (Custom)' : ''}</div>
            </div>
            <div class="detail-dist"><div class="km">-</div></div>
        </div>`;

    let prevLat = startPt?.lat, prevLng = startPt?.lng, prevName = getShortName(startPt?.name || 'Bandara');

    route.forEach((id, idx) => {
        const s = stores.find(x => x.id === id);
        if (s) {
            const d = dist(prevLat, prevLng, s.lat, s.lng);
            const t = Math.round((d / 40) * 60);
            html += `
                <div class="detail-item" onclick="focusStore(${s.id})">
                    <div class="detail-num">${idx + 1}</div>
                    <div class="detail-info">
                        <div class="detail-name">${s.name}</div>
                        <div class="detail-sub">${s.area} ‚Ä¢ ${s.city}</div>
                        <div class="detail-from">dari ${prevName}</div>
                    </div>
                    <div class="detail-dist">
                        <div class="km">${d.toFixed(1)} km</div>
                        <div class="time">~${t} menit</div>
                    </div>
                </div>`;
            prevLat = s.lat;
            prevLng = s.lng;
            prevName = getShortName(s.name);
        }
    });

    document.getElementById('detailList').innerHTML = html;
    document.getElementById('detailPanel').classList.add('visible');
}

function closeDetail() { document.getElementById('detailPanel').classList.remove('visible'); }

function focusStore(id) {
    const s = stores.find(x => x.id === id);
    if (s) {
        map.setView([s.lat, s.lng], 15);
        showStorePopup(s);
    }
}

function fitAll() { map.fitBounds(stores.map(s => [s.lat, s.lng]), { padding: [30, 30] }); }
function focusBranch(br) { const bs = stores.filter(s => s.branch === br); if (bs.length) map.fitBounds(bs.map(s => [s.lat, s.lng]), { padding: [50, 50] }); }
function toggleSat() { if (isSat) { map.removeLayer(satLayer); map.addLayer(defLayer); } else { map.removeLayer(defLayer); map.addLayer(satLayer); } isSat = !isSat; document.getElementById('satBtn').classList.toggle('active'); }

function openGMaps() {
    if (!route.length) { toast('Tambahkan toko dulu', 'error'); return; }
    const startPt = getStartPoint();
    let url = 'https://www.google.com/maps/dir/';
    if (startPt) url += `${startPt.lat},${startPt.lng}/`;
    route.forEach(id => { const s = stores.find(x => x.id === id); if (s) url += `${s.lat},${s.lng}/`; });
    window.open(url, '_blank');
}

// Storage
function save() {
    localStorage.setItem('zumaRoute', JSON.stringify(route));
    if (customStart) {
        localStorage.setItem('zumaCustomStart', JSON.stringify(customStart));
    } else {
        localStorage.removeItem('zumaCustomStart');
    }
}

function load() {
    try {
        const r = localStorage.getItem('zumaRoute');
        if (r) route = JSON.parse(r);

        const cs = localStorage.getItem('zumaCustomStart');
        if (cs) {
            const parsed = JSON.parse(cs);
            setCustomStart(parsed.name, parsed.lat, parsed.lng);
        }
    } catch(e){}
}

function exportCSV() {
    const startPt = getStartPoint();
    let csv = 'No,Nama Toko,Area,Kota,Alamat,Jarak dari Sebelumnya,Dari\n';
    let prevLat = startPt?.lat, prevLng = startPt?.lng, prevName = startPt?.name || 'Bandara';

    route.forEach((id, i) => {
        const s = stores.find(x => x.id === id);
        if (s) {
            const d = prevLat ? dist(prevLat, prevLng, s.lat, s.lng).toFixed(1) : '0';
            csv += `${i+1},"${s.name}","${s.area}","${s.city}","${s.address}","${d} km","${prevName}"\n`;
            prevLat = s.lat; prevLng = s.lng; prevName = s.name;
        }
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `zuma-route-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    toast('CSV diexport', 'success');
}

// Mobile Navigation Functions
function mobileShowMap() {
    document.querySelector('.sidebar').classList.remove('open');
    updateMobileNav('map');
    setTimeout(() => map.invalidateSize(), 100);
}

function mobileShowStores() {
    document.querySelector('.sidebar').classList.add('open');
    switchTab('stores');
    updateMobileNav('stores');
}

function mobileShowRoute() {
    document.querySelector('.sidebar').classList.add('open');
    switchTab('route');
    updateMobileNav('route');
}

function updateMobileNav(active) {
    document.querySelectorAll('.nav-btn').forEach((btn, i) => {
        btn.classList.remove('active');
        if ((active === 'map' && i === 0) ||
            (active === 'stores' && i === 1) ||
            (active === 'route' && i === 2)) {
            btn.classList.add('active');
        }
    });
}

function updateMobileRouteBadge() {
    const badge = document.getElementById('mobileRouteBadge');
    if (badge) {
        badge.textContent = route.length;
        badge.style.display = route.length > 0 ? 'block' : 'none';
    }
}

// Override save to also update mobile badge
const originalSave = save;
save = function() {
    originalSave();
    updateMobileRouteBadge();
}

// Initialize mobile badge on load
document.addEventListener('DOMContentLoaded', () => {
    updateMobileRouteBadge();
});

// Close sidebar when clicking on map marker on mobile
const originalFocusStore = focusStore;
focusStore = function(id) {
    if (window.innerWidth <= 768) {
        mobileShowMap();
    }
    originalFocusStore(id);
}
    </script>
</body>
</html>
